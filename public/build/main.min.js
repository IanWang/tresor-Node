/*! application-name - v0.0.1 - 2013-09-24 */function isMoney(a){return/^(\d*\.\d{1,2}|\d+)$/.test(a)}function Ajax(a,b,c){$.ajax({url:a,type:"GET",data:b,dataType:"json",success:c})}function initLightBox(){$(".ajax-href").click(function(){var a=$(this).attr("data-id"),b="/product/"+a,c=$("#inline_content"),d=b;history.pushState(b,"",b),$.ajax({url:d,type:"GET",data:{light:!0},dataType:"html",success:function(a){c.empty(),c.append(a)},error:function(){}})}),$(".ajax-href").colorbox({inline:!0,fixed:!0,width:"80%",height:"98%",onCleanup:function(){history.pushState("/","","/")}})}var objId,data2=JSON.stringify({bought:264,des:"Birderly, like never before.",gender:"M",title:"Jeff Birdy18",size:"XL",sold:300,type:"book"});Dropzone.options.myDropzone={paramName:"images",maxFilesize:4,addRemoveLinks:!0,dictRemoveFile:"remove",parallelUploads:10,autoProcessQueue:!1,acceptedFiles:"image/*"},Dropzone.autoDiscover=!1,$(function(){var a=new Dropzone("#my-dropzone");$("#p-type").change(function(){var a=["accessories","cosmeceutical","electronics","book","textbook","others"],b=$("#p-type").val();-1==a.indexOf(b)?"shoes"===b?($("#only-shoes").show(),$("#p-size").hide(),$(".sizeChart").colorbox()):($("#p-size").show(),$("#only-shoes").hide()):($("#p-size").hide(),$("#only-shoes").hide())}),$("#submit").click(function(){var b=$(".dz-preview"),c=$("#p-name").val(),d=$("#p-gender").val(),e=$("#p-type").val(),f=$("#p-size").val()||$("#p-shoes-size").val(),g=$("#p-status").val(),h=$("#p-des").val(),i=parseInt($("#p-bought").val(),10),j=parseInt($("#p-sold").val(),10),k="";if(0==b.length&&(k+="至少需上傳一張圖片哦\n"),c||(k+="商品名稱為必填\n"),g||(k+="商品狀態為必填\n"),j?isMoney(j)||(k+="欲售價格格式錯誤\n"):k+="欲售價格為必填\n",k&&alert(k),""==k){var l=JSON.stringify({bought:i,des:h,gender:d,title:c,status:g,size:f,sold:j,type:e});console.log(l),$.ajax({url:"/create",type:"POST",contentType:"application/json",data:l,dataType:"json",success:function(b){b.status&&b.id&&(objId=b.id,console.log(b),console.log(objId),a.processQueue(),console.log("新增成功"))},error:function(){window.alert("failure")}})}}),a.on("sending",function(a,b,c){c.append("ObjectId",objId)})}),$(document).ready(function(){$("#p-name").focus(),$("#p-name").tooltip({html:!0,title:'<p style="font-weight:bold;font-size:14px;margin:4px;">LOHA!!<br>此欄為必填</p>',placement:"right"}),$("#p-status").tooltip({html:!0,title:'<p style="font-weight:bold; font-size:14px; margin:4px;">此欄為必填</p>',placement:"right"}),$("#p-sold").tooltip({html:!0,title:'<p style="font-weight:bold; font-size:14px; margin:4px;">此欄為必填</p>',placement:"right"}),$("#p-shoes-size").tooltip({html:!0,title:'<p style="margin: 4px; font-size: 14px;font-weight: bold">為便於搜尋，請統一使用歐碼</p>',placement:"right"})});var defaultPath="/",getUrl=$(location).attr("href").split("/"),id=getUrl[getUrl.length-1],apiUrl="/action",query={},count;query.status={action:"get_status",method:"get",id:id},query.bQueue={action:"queue",id:id},query.bDequeue={action:"dequeue",id:id},query.bConfirm={action:"confirm",id:id},query.bUnconfirm={action:"unconfirm",id:id},query.sConfirm={action:"confirm",id:id},query.sUnconfirm={action:"unconfirm",id:id},$(".picbar img").click(function(){$(".imgContainer").empty();var a=$(this).attr("rel");$(".imgContainer").append('<img src="'+a+'" style="display: none;"/>'),$(".imgContainer img").fadeIn("slow")}),$(".listBlock li .sCon").click(function(){$(this).hide(),$(this).parent().find(".sUncon").show();var a=$(this).parent().attr("data-id");query.sConfirm.buyer=a,Ajax(apiUrl,query.sConfirm,function(a){"ok"===a.msg?(alert("雙方均送出確認\n交易結束"),window.location="/"):alert("已確認此筆交易\n等候買家回覆中...")})}),$(".listBlock li .sUncon").click(function(){$(this).hide(),$(this).parent().find(".sCon").show();var a=$(this).parent().attr("data-id");query.sUnconfirm.buyer=a,Ajax(apiUrl,query.sUnconfirm,function(a){console.log("sUn",a)})}),$(".C .confirm").click(function(){$(".C .tranBtn").hide(),$(".C .unconfirm").show(),Ajax(apiUrl,query.bConfirm,function(a){console.log("bCon",a),"ok"===a.msg?(alert("雙方均送出確認\n交易結束"),window.location="/"):alert("已確認此筆交易\n等待賣家回覆中")})}),$(".C .unconfirm").click(function(){$(".C .tranBtn").hide(),$(".C .dequeue").show(),$(".C .confirm").show(),Ajax(apiUrl,query.bUnconfirm,function(a){console.log("bUn",a)})}),$(".C .buy").click(function(){$(".C .tranBtn").hide(),$(".C .dequeue").show(),$(".C .confirm").show(),Ajax(apiUrl,query.bQueue,function(a){alert("已將您排入商品\n請主動聯絡賣家"),console.log("bQue",a)})}),$(".C .dequeue").click(function(){$(".C .tranBtn").hide(),$(".C .buy").show(),Ajax(apiUrl,query.bDequeue,function(a){console.log("bDeq",a)})}),$(".listBlock .lightSendMsg").click(function(){var a=$(this).parent().attr("data-fb"),b=$(".buyerName").html(),c="https://www.facebook.com/messages/"+a,d=confirm("您即將與"+b+"對談\n提醒您，多加留意交易細節及人身安全");1==d&&(window.open(c,"_blank"),$(".msgTarget").html(b),$(".modal-footer a").attr("href",c))}),$(".listBlock .SsendMsg").click(function(){var a=$(this).parent().attr("data-fb"),b=$(".buyerName").html(),c="https://www.facebook.com/messages/"+a;$(".msgTarget").html(b),$(".modal-footer a").attr("href",c)});var types={clothes:"上衣",coat:"外套",pantskirt:"褲裙",dress:"連身裝",shoes:"鞋類",accessories:"飾品",cosmeceutical:"藥妝",electronics:"3C產品",book:"一般書籍",textbook:"**教科書**",others:"其他"},cType=$("#category").html(),newType=types[cType];$("#category").html(newType),$("#a").click(function(){$(".my_box").children().each(function(){return $(this).hide()}),$("#my-item").show()}),$("#b").click(function(){$(".my_box").children().each(function(){return $(this).hide()}),$("#my-follow").show()}),$("#c").click(function(){$(".my_box").children().each(function(){return $(this).hide()}),$("#my-history").show()}),$("#a").trigger("click"),$("#myTab a:first").tab("show");var apiUrl="/userProduct",render_from_tpl=doT.template('<div class="item"><a href="#inline_content" data-id="{{=it.id}}" class="ajax-href"><img class="imgFade" src="{{=it.img_path}}"></a><div class="myproduct-info"><div class="mer_title"><span>{{=it.name}}</span></div><div class="mer_date"><span>{{=it.date}}</span></div><div class="mer_count"><span>{{=it.count}}</span></div></div></div>');$.ajax({url:apiUrl,type:"GET",dataType:"json",success:function(a){console.log(a),a.forEach(function(a){var b={img_path:a.img,name:a.title,date:a.date,count:a.waiting,id:a.id};$("#my-item").append(render_from_tpl(b))}),initLightBox()},error:function(a){console.log(a)}}),$(function(){var a=$(".masonry"),b=!1,c={},d=!1,e=function(){return d=!0,console.log(b),b?console.log(0):$.ajax({url:"/allProduct",type:"GET",contentType:"application/json",data:c,dataType:"json",success:function(a){c.page=a.meta.next,g(a),null==c.page&&(b=!0,$(".end").fadeIn("slow"))}})},f=doT.template('<div class="item"><a href="#inline_content" data-id="{{=it.id}}" class="ajax-href"><img src="{{=it.image[0].w236.relative_path}}" style="height: {{=it.image[0].w236.height}}px" class="imgFade"></a><div class="info"></a><div class="title"><a href="#">{{=it.title}}</a></div><div class="seller"><a href="#">{{=it.seller.facebook_name}}</a></div><div class="price">${{=it.sold_price}}</div></div></div>'),g=function(b){b.objects.forEach(function(b){try{a.append(f(b))}catch(c){console.log("no img")}}),a.masonry("reload"),d=!1,$(".ajax-href").click(function(){$("#inline_content").empty();var a=$(this).attr("data-id"),b="/product/"+a,c=$("#inline_content"),d=b;history.pushState(b,"",b),$.ajax({url:d,type:"GET",data:{light:!0},dataType:"html",success:function(a){c.empty(),c.append(a)},error:function(){}})}),$(".ajax-href").colorbox({inline:!0,fixed:!0,width:"1050",height:"98%",onCleanup:function(){history.pushState("/","","/")}})};$(window).load(function(){a.masonry({itemSelector:".item",columnWidth:250,isFitWidth:!0}),$(window).scroll(function(){$(window).scrollTop()>=$(document).height()-$(window).height()-300&&(d||e(g))}),$(window).trigger("scroll")}),$(window).resize(function(){a.masonry("reload")})});